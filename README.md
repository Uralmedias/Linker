# Uralmedias Linker

Набор классов для програмного анализа и редактирования веб-содержимого. Предполагаемые сферы применения:

* Редизайн и интеграция верстки
* Тестирование и оптимизация страниц
* Создание грабберов и парсеров

Идея для названия позаимствована у одноименного класса утилит, используемых в разработке на компилируемых языках программирования. Эти утилиты (линкеры, линковщики или компановщики) используются на последнем этапе сборки для того, чтобы объединить скомпилированные, но разрозненные части приложения в целостную систему, освобождая разработчиков от необходимости делать это вручную, контролируя особенности данного процесса и каждой конкретной системы.
При использовании в интеграции верстки позволяет создавать сценарии сборки вместо обычного подхода, когда макеты верстки используются как исходники для следующего этапа. В перспективе это позволяет значительно сократить сложность исходного кода и участие специалистов в процессе внесения визуальных правок.

## API

### Фасады

#### `Layout` — Создание фрагментов разметки

```php
abstract class Layout
```

Фасад, который служит точкой входа для всех манипуляций с макетом. Созданные фрагменты не привязаны к данным, из которых они создаются, чтобы обеспечить целостность и ожидаемое поведение во время обработки. Если в каком-то случае требуется кэширование или что-то в этом роде, необходимо предусмотреть это в конкретном случае. Из-за многочисленных трудностей и неоднозначных ситуаций библиотека пока не использует кэширование, кроме ситуаций, где оно явно и точно ни на что не может повлиять отрицательно.

```php
// Подключение
use Uralmedias\Linker\Layout;
```

Методы загрузки фрагментов верстки:

```php
// Из набора узлов DOM.
public static function fromNodes (DOMNode ...$nodes): LayoutFragment;

// Из документа DOM.
public static function fromDocument (DOMDocument $document): LayoutFragment;

// Из произвольной сырой строки.
public static function fromHTML (string $contents): LayoutFragment;

// Из локального файла или URL.
public static function fromFile (string $filename): LayoutFragment;

// Из буфера вывода при выполнении функции.
public static function fromOutput (callable $process): LayoutFragment;

```

#### `Select` — Интерпритация селекторов

```php
abstract class Select
```

Фасад, который позволяет использовать разные способы указания узлов разметки. Более лаконичные селекторы CSS вместо более мощных запросов XPath, например. Так же поддерживаются целочисленные индексы.

```php
// Подключение
use Uralmedias\Linker\Select;
```

Доступные статические методы:

```php
// Автоматически определеить тип селектора.
public static function auto ($pattern): string;

// Целочисленный индекс. Положительный начинается с 0
// и указывает позицию с начала, отрицательный начинается
// с -1 и указывает позицию с конца.
public static function at (int $index): string;

// Селектор CSS (будет преобразован в XPath).
public static function css (string $css): string;
```

### Работа с разметкой

#### `LayoutFragment` — Контейнер фрагмента разметки

Владеет экземпляром `DOMDocument` и служит адаптером к его API. Может быть преобразован в строку для вывода, при клонировании копирует имеющийся `DOMDocument`. Может быть инстанциирован при помощи фасада `Layout`.

#### `NodeRegrouping` — Редактирование структуры разметки

```php
public function __construct(DOMXPath $target, DOMNode ...$source)
```

Создаётся в процессе редактирования структуры как завершающий этап вставки. Позволяет выбрать место размещения новых узлов. Длительное хранение экземпляров не желательно, так как используемые ссылки на узлы могут портится как самим экземпляром, так и внешними факторами.``Создаётся в процессе редактирования структуры как завершающий этап вставки. Позволяет выбрать место размещения новых узлов. Длительное хранение экземпляров не желательно, так как используемые ссылки на узлы могут портится как самим экземпляром, так и внешними факторами.

#### `NodeProperties` — Доступ к свойствам и атрибутам

```php
public function __construct(DOMNode ...$nodes);
```

Создаётся на основе ссылок на узлы и даёт доступ к чтению и редактированию их свойств и атрибутов. Некоторые действия могут приводить к порче старых ссылок, поэтому длительное хранение объектов нежелательно.

```php
// Названия узлов
public function name (string $update = NULL): string;
```

Для элемента это — тэг, для атрибута это — токен перед "=", узлы других типов не могут иметь имя, в этом случае значение не устанавливается, а возвращается пустая строка.

```php
// Значения узлов
public function value (string $update = NULL): string;
```

Для элемента, коментария или текстового узла это — его текст, для атрибута - это выражение после "=". Для задания нового значения нужно передать аргумент.

```php
// Inline-стили элементов
public function styles (array $updates = NULL): array;
```

Возвращает массив, ключами которого служат имена атрибутов стиля, а значениями — их значения. Заполненный аргумент заменяет текущее значение. Парсер очень неаккуратный, нужно пользоваться осторожно.

```php
// Классы элементов
public function classes (array $updates = NULL, bool $doReplacing = FALSE, bool $assumeRE = FALSE): array;
```

Возвращает массив CSS-классов. Чтобы изменить значения, необходимо передать первым аргументом массив, при этом поведение вариируется:

- По умолчанию: ключи соответствуют удаляемым классам, значения - добавляемым;
- `$doReplacing = TRUE`: ключи соответствуют шаблонам поиска, значения - подстановкам;
- `$assumeRE = TRUE`: то, что и предыдущий, но шаблоны поиска - регулярные выражения.

При использовании регулярных выражений можно использовать групировки и подстановки.

```php
// Атрибуты элементов
public function attributes (array $updates = NULL, bool $nullValues = FALSE): array;
```

Доступ к атрибутам элементов. Возвращает атрибуты в виде массива ```ключ => значение```, принимает новое значение в таком же виде. При отсустствии ключа в аргументе, значение атрибута остаётся не тронутым. Если ```значение === NULL```, атрибут удаляется, кроме случаев, когда ```$nullValues = TRUE```. В этом случае устанавливается ```NULL```.

## Пример

Больше примеров можно найти в директории `examples`.

```php
// Актуальное место, где находится /linker/vendor/autoload.php, но
// если проект уже использует composer и библиотека подключена через
// него, то следующая строка становится не нужной. Это надо, чтобы
// классы библиотеки стали доступными загрузчику классов.
require_once __DIR__ .'/../../../linker/vendor/autoload.php';

// Главный класс библиотеки, который загружает
// фрагменты верстки и позволяет работать с ними
use Uralmedias\Linker\Layout;


// Загружаем верстку из файла. Также верстка может быть загружена
// из сети, из строки, из стандартного вывода подпрограммы,
// а еще - из ранее созданных узлов DOM. (см. комментарии в коде)
$index = Layout::fromFile('markup.html');

// Вырезаем блоки с классом .w3-row.w3-padding-64 и изапоминаеи
// первый из них в переменную $row - он пригодится нам, чтобы
// формировать новые элементы.
$row = $index->cut('.w3-row.w3-padding-64')->cut(1);

// Так же вырезем (удаляем) остальные блоки, которые нам не нужны
$index->cut('.w3-row');


// Наполняем вырезанный блок рыбой
// Здесь использованы два варианта установки текста,
// второй позволяет дополнительно читать текст из узлов.
$row->write('Hello world!')->into('h1');
$row->nodes('.w3-twothird p')->value('С другой стороны укрепление и развитие структуры играет
важную роль в формировании системы обучения кадров, соответствует
насущным потребностям. Задача организации, в особенности же новая
модель организационной деятельности в значительной степени обуславливает
создание модели развития. С другой стороны укрепление и развитие
структуры влечет за собой процесс внедрения и модернизации направлений
прогрессивного развития. Задача организации, в особенности же реализация
намеченных плановых заданий требуют от нас анализа позиций, занимаемых
участниками в отношении поставленных задач. Задача организации,
в особенности же консультация с широким активом представляет собой
интересный эксперимент проверки дальнейших направлений развития.');

// Далее переменная $row может быть использована повторно,
// а можно на этом ограничиться
// Заполняем блоками основной фрагмент
$index->put($row)->up('.w3-main');

// Удаляем лишние пробельные символы - не обязательно,
// но позволяет облегчить страницу, иногда - на 20-25%.
$index->minimize(TRUE,TRUE);

// Вывод содержимого фрагмента
echo $index;
```
